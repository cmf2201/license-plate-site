<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>License Plates by State</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
    h1 { text-align: center; }
    .grid-container {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 15px;
      margin-top: 30px;
    }
    .plate-box {
      background: white;
      border-radius: 8px;
      padding: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
      cursor: pointer;
    }
    .plate-box img {
      width: 100%;
      height: auto;
      border-radius: 4px;
    }
    .plate-name {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #333;
      word-break: break-word;
    }
    .plate-box.seen {
      background-color: #d4edda;
      border: 2px solid #28a745;
    }

    @media (max-width: 768px) {
      .grid-container {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 500px) {
      .grid-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <h1 id="title">Loading...</h1>
  <div class="grid-container" id="plates-container">Loading plates...</div>

<script>
  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  function parseGoogleSheetData(rawText) {
    const json = JSON.parse(rawText.substring(47).slice(0, -2));
    const cols = json.table.cols.map(col => col.label);
    const rows = json.table.rows;

    return rows.map(row => {
      const obj = {};
      row.c.forEach((cell, i) => {
        if (cell) obj[cols[i]] = cell.v;
      });
      return obj;
    });
  }

  const state = getQueryParam('state');
  const title = document.getElementById('title');
  const container = document.getElementById('plates-container');

  if (!state) {
    title.textContent = "Error: No state specified.";
    container.innerHTML = "";
  } else {
    title.textContent = `Plates from ${state}`;

    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1X3oVox7VSsRCcUtQdQV8FxUT00sl2b2D0Jrv-rSuLno/gviz/tq?tqx=out:json";
    const FORM_BASE = "https://docs.google.com/forms/d/e/1FAIpQLScSdoTszuz61LupEfd6_nZC-Bu8YQBYoFg4SO4p_LC-CkMLnA/viewform?usp=pp_url";
    const ENTRY_ID = "entry.23481005";  // Replace with real entry ID

    Promise.all([
      fetch("files/state_images.json").then(res => res.json()),
      fetch("files/licenseplates.json").then(res => res.json()),
      fetch(SHEET_URL).then(res => res.text()).then(parseGoogleSheetData)
    ]).then(([imagePaths, plateNamesByState, formData]) => {
      const plateNames = plateNamesByState[state];
      const imagePathsForState = imagePaths[state];

      if (!plateNames || !imagePathsForState) {
        container.innerHTML = "<p>No plates found for this state.</p>";
        return;
      }

      const imageLookup = {};
      imagePathsForState.forEach(path => {
        const key = path.split('/').pop().replace(/\.(jpg|jpeg|png)$/i, '');
        imageLookup[key] = path;
      });

      const sightings = {};
      const columnHeader = "What Plate Did You See?";

      formData.forEach(row => {
        let plate = row[columnHeader]?.trim();
        const timestamp = row["Timestamp"];
        if (plate) {
          // Remove state prefix (e.g., "AK - In-God-We-Trust" → "In-God-We-Trust")
          const parts = plate.split(" - ");
          plate = parts.length > 1 ? parts[1] : parts[0];

          if (!sightings[plate]) sightings[plate] = { count: 0, lastDate: null };
          sightings[plate].count += 1;

          const match = /Date\((.*?)\)/.exec(timestamp);
          if (match) {
            const parts = match[1].split(',').map(Number);
            const jsDate = new Date(parts[0], parts[1], parts[2], parts[3], parts[4], parts[5]);
            if (!sightings[plate].lastDate || jsDate > sightings[plate].lastDate) {
              sightings[plate].lastDate = jsDate;
            }
          }
        }
      });


      container.innerHTML = "";
      plateNames.forEach(plateName => {
        const data = sightings[plateName] || { count: 0, lastDate: "Never" };
        const imagePath = imageLookup[plateName];
        const formURL = `${FORM_BASE}&${ENTRY_ID}=${encodeURIComponent(`${state} - ${plateName}`)}`;

        if (!imagePath) return;

        const box = document.createElement("div");
        box.className = "plate-box";
        if (data.count > 0) box.classList.add("seen");
        box.onclick = () => window.open(formURL, '_blank');

        box.innerHTML = `
          <img src="${imagePath}" alt="${plateName}">
          <div class="plate-name">
            ${plateName}<br>
            <strong>Seen: ${data.count}×</strong><br>
            <small>Last seen: ${
              data.lastDate instanceof Date
                ? data.lastDate.toLocaleString("en-US", {
                    month: "2-digit", day: "2-digit", year: "2-digit",
                    hour: "2-digit", minute: "2-digit", second: "2-digit",
                    hour12: false
                  })
                : data.lastDate
            }</small>
          </div>
        `;
        container.appendChild(box);
      });
    }).catch(err => {
      console.error("Failed to load data:", err);
      container.innerHTML = "<p>Error loading plates.</p>";
    });
  }
</script>

</body>
</html>
