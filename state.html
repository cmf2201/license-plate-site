<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>License Plates by State</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
    h1 { text-align: center; }
    .grid-container {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 15px;
      margin-top: 30px;
    }
    .plate-box {
      background: white;
      border-radius: 8px;
      padding: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
    }
    .plate-box img {
      width: 100%;
      height: auto;
      border-radius: 4px;
    }
    .plate-name {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #333;
      word-break: break-word;
    }
    .plate-box.seen {
      background-color: #d4edda;  /* Light green */
      border: 2px solid #28a745;
    }

    /* Responsive breakpoints */
    @media (max-width: 768px) {
      .grid-container {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 500px) {
      .grid-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <h1 id="title">Loading...</h1>
  <div class="grid-container" id="plates-container">Loading plates...</div>

<script>
  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  function parseGoogleSheetData(rawText) {
    const json = JSON.parse(rawText.substring(47).slice(0, -2));
    const cols = json.table.cols.map(col => col.label);
    const rows = json.table.rows;

    return rows.map(row => {
      const obj = {};
      row.c.forEach((cell, i) => {
        if (cell) obj[cols[i]] = cell.v;
      });
      return obj;
    });
  }


  const state = getQueryParam('state');
  const title = document.getElementById('title');
  const container = document.getElementById('plates-container');

  if (!state) {
    title.textContent = "Error: No state specified.";
    container.innerHTML = "";
  } else {
    title.textContent = `Plates from ${state}`;

    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1VJ6I5uc7rG7zk6-zMU8oPipd-o1kn-mdD6MOf2eOCIg/gviz/tq?tqx=out:json";

    Promise.all([
      fetch("files/state_images.json").then(res => res.json()),
      fetch(SHEET_URL).then(res => res.text()).then(parseGoogleSheetData)
    ]).then(([stateImages, formData]) => {
      const images = stateImages[state];
      if (!images || images.length === 0) {
        container.innerHTML = "<p>No plates found for this state.</p>";
        return;
      }

      const sightings = {};
      const columnHeader = `Choose a plate from ${state}`;

      formData.forEach(row => {
        const plate = row[columnHeader]?.trim();
        const timestamp = row["Timestamp"];
        if (plate) {
          if (!sightings[plate]) {
            sightings[plate] = { count: 0, lastDate: null };
          }
          sightings[plate].count += 1;

          // Handle Google Sheets Date("YYYY,MM,DD,HH,mm,ss") format
          if (timestamp && typeof timestamp === "string") {
            const match = /Date\((.*?)\)/.exec(timestamp);
            if (match) {
              const parts = match[1].split(',').map(Number);
              const jsDate = new Date(parts[0], parts[1], parts[2], parts[3], parts[4], parts[5]);
              sightings[plate].lastDate = jsDate;
            }
          }
        }
      });

      container.innerHTML = "";
      images.forEach(path => {
        const plateName = path.split('/').pop().replace(/\.(jpg|jpeg|png)$/i, '');
        const data = sightings[plateName] || { count: 0, lastDate: "Never" };

        const box = document.createElement("div");
        box.className = "plate-box";
        if (data.count > 0) {
          box.classList.add("seen");
        }

        box.innerHTML = `
          <img src="${path}" alt="${plateName}">
          <div class="plate-name">
            ${plateName}<br>
            <strong>Seen: ${data.count}Ã—</strong><br>
            <small>Last seen: ${
              data.lastDate instanceof Date
                ? data.lastDate.toLocaleString("en-US", {
                    month: "2-digit",
                    day: "2-digit",
                    year: "2-digit",
                    hour: "2-digit",
                    minute: "2-digit",
                    second: "2-digit",
                    hour12: false
                  })
                : data.lastDate
            }</small>
          </div>
        `;
        container.appendChild(box);
      });
    }).catch(err => {
      console.error("Failed to load data:", err);
      container.innerHTML = "<p>Error loading plates.</p>";
    });

  }
</script>


</body>
</html>
