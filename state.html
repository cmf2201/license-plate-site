<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>License Plates by State</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #252526; color: #f5f5f5; }
    h1 { text-align: center; }
    .section-header {
      font-size: 1.2rem;
      margin-top: 40px;
      margin-bottom: 10px;
      color: #f5f5f5;
    }
    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
      margin-bottom: 40px;
    }
    .plate-box {
      background: #3e3e42;
      border-radius: 8px;
      padding: 8px;
      box-shadow: 0 2px 4px rgba(255,255,255,0.05);
      text-align: center;
      cursor: pointer;
      color: #f5f5f5;
    }
    .plate-box img {
      width: 100%;
      height: auto;
      border-radius: 4px;
    }
    .plate-name {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #f5f5f5;
      word-break: break-word;
    }

    .plate-box.seen {
      background-color: #409454;
      border: 2px solid #0a2c12;
    }
    @media (max-width: 768px) {
      .grid-container {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 500px) {
      .grid-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <h1 id="title">Loading...</h1>
  <p style="text-align:center;">
    <a href="index.html" style="text-decoration:none; font-size:0.9rem; color:#007bff;">← Back to Home</a>
  </p>
  <div id="plates-wrapper">Loading plates...</div>

<script>
  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  function parseGoogleSheetData(rawText) {
    const json = JSON.parse(rawText.substring(47).slice(0, -2));
    const cols = json.table.cols.map(col => col.label);
    const rows = json.table.rows;

    return rows.map(row => {
      const obj = {};
      row.c.forEach((cell, i) => {
        if (cell) obj[cols[i]] = cell.v;
      });
      return obj;
    });
  }

  const state = getQueryParam('state');
  const title = document.getElementById('title');
  const wrapper = document.getElementById('plates-wrapper');

  if (!state) {
    title.textContent = "Error: No state specified.";
    wrapper.innerHTML = "";
  } else {
    title.textContent = `Plates from ${state}`;

    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1X3oVox7VSsRCcUtQdQV8FxUT00sl2b2D0Jrv-rSuLno/gviz/tq?tqx=out:json";
    const FORM_BASE = "https://docs.google.com/forms/d/e/1FAIpQLScSdoTszuz61LupEfd6_nZC-Bu8YQBYoFg4SO4p_LC-CkMLnA/viewform?usp=pp_url";
    const ENTRY_ID = "entry.23481005";

    Promise.all([
      fetch("us-license-plates/json_files/nested_categories.json").then(res => res.json()),
      fetch("us-license-plates/json_files/plate_names.json").then(res => res.json()),
      fetch(SHEET_URL).then(res => res.text()).then(parseGoogleSheetData)
    ]).then(([imagePaths, plateNamesByState, formData]) => {
      const plateNamesByCategory = plateNamesByState[state];
      const imagePathsByCategory = imagePaths[state];

      if (!plateNamesByCategory || !imagePathsByCategory) {
        wrapper.innerHTML = "<p>No plates found for this state.</p>";
        return;
      }

      // Build image lookup table
      const imageLookup = {};
      Object.entries(imagePathsByCategory).forEach(([category, paths]) => {
        paths.forEach(path => {
          const key = path.split('/').pop().replace(/\.(jpg|jpeg|png)$/i, '');
          imageLookup[key] = { path, category };
        });
      });

      // Collect plate sightings from form data
      const sightings = {};
      const columnHeader = "What Plate Did You See?";
      formData.forEach(row => {
        let plate = row[columnHeader]?.trim();
        const timestamp = row["Timestamp"];
        if (plate) {
          const parts = plate.split(" - ");
          plate = parts.length > 1 ? parts[1] : parts[0];
          if (!sightings[plate]) sightings[plate] = { count: 0, lastDate: null };
          sightings[plate].count += 1;

          const match = /Date\((.*?)\)/.exec(timestamp);
          if (match) {
            const parts = match[1].split(',').map(Number);
            const jsDate = new Date(parts[0], parts[1], parts[2], parts[3], parts[4], parts[5]);
            if (!sightings[plate].lastDate || jsDate > sightings[plate].lastDate) {
              sightings[plate].lastDate = jsDate;
            }
          }
        }
      });

      wrapper.innerHTML = "";

      // Render each category section
      Object.entries(plateNamesByCategory).forEach(([category, plateList]) => {
        const section = document.createElement("div");

        const header = document.createElement("h2");
        header.className = "section-header";
        header.textContent = category.charAt(0).toUpperCase() + category.slice(1);
        section.appendChild(header);

        const grid = document.createElement("div");
        grid.className = "grid-container";

        plateList.forEach(plateName => {
          const lookup = imageLookup[plateName];
          if (!lookup || lookup.category !== category) return;

          const data = sightings[plateName] || { count: 0, lastDate: "Never" };
          const formURL = `${FORM_BASE}&${ENTRY_ID}=${encodeURIComponent(`${state} - ${plateName}`)}`;

          const box = document.createElement("div");
          box.className = "plate-box";
          if (data.count > 0) box.classList.add("seen");
          box.onclick = () => window.open(formURL, '_blank');

          box.innerHTML = `
            <img src="${lookup.path}" alt="${plateName}">
            <div class="plate-name">
              ${plateName}<br>
              <strong>Seen: ${data.count}×</strong><br>
              <small>Last seen: ${
                data.lastDate instanceof Date
                  ? data.lastDate.toLocaleString("en-US", {
                      month: "2-digit", day: "2-digit", year: "2-digit",
                      hour: "2-digit", minute: "2-digit", second: "2-digit",
                      hour12: false
                    })
                  : data.lastDate
              }</small>
            </div>
          `;
          grid.appendChild(box);
        });

        section.appendChild(grid);
        wrapper.appendChild(section);
      });
    }).catch(err => {
      console.error("Failed to load data:", err);
      wrapper.innerHTML = "<p>Error loading plates.</p>";
    });
  }
</script>

</body>
</html>
